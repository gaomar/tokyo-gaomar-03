
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>M5StickC &#43; LINE Things &#43; Amazon Connecté€£æºãƒãƒ³ã‚ºã‚ªãƒ³</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="dist"
                  title="M5StickC &#43; LINE Things &#43; Amazon Connecté€£æºãƒãƒ³ã‚ºã‚ªãƒ³"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="å•ã„åˆã‚ã›ãƒ•ãƒ­ãƒ¼ã‚’ä½œã‚ã†ï¼" duration="0">
        <h2 is-upgraded>Amazon Connecté›»è©±ç•ªå·å–å¾—</h2>
<p>ã™ã§ã«Amazon Connectã®é›»è©±ç•ªå·ã‚’å–å¾—ã—ã¦ã„ã‚‹å‰æã§é–‹å§‹ã—ã¾ã™ã€‚<br>ã¾ã æœªå–å¾—ãªæ–¹ã¯ã“ã¡ã‚‰ã‹ã‚‰ç•ªå·ã‚’å–å¾—ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚</p>
<p><a href="https://ac-handson-00.netlify.com" target="_blank">https://ac-handson-00.netlify.com</a></p>
<h2 is-upgraded>1-1. å•ã„åˆã‚ã›ãƒ•ãƒ­ãƒ¼ã®ä½œæˆ</h2>
<p>å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‹ã‚‰ã€Œå•ã„åˆã‚ã›ãƒ•ãƒ­ãƒ¼ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s100" src="img/f7defc0dbcfc0fae.png"></p>
<p>ï¼»å•ã„åˆã‚ã›ãƒ•ãƒ­ãƒ¼ã®ä½œæˆï¼½ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s101" src="img/a2f8135bdb84e534.png"></p>
<p>åå‰ã‚’ã€ŒM5Stick-AmazonConnectã€ã¨å…¥åŠ›ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s102" src="img/b2deea2f368bad83.png"></p>
<p>è¨­å®šã‚«ãƒ†ã‚´ãƒªã«ã‚ã‚‹ã€ŒéŸ³å£°ã®è¨­å®šã€ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ã€ãƒ‰ãƒ­ãƒƒãƒ—ã—ãŸãƒ–ãƒ­ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s103" src="img/e2bdb3d3d43529bc.png"></p>
<p>è¨€èªã¯ã€Œæ—¥æœ¬èªã€ã§ãŠå¥½ããªéŸ³å£°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img alt="s104" src="img/bf8c94c0a4182d49.png"></p>
<p>ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã¨éŸ³å£°ã®è¨­å®šãƒ–ãƒ­ãƒƒã‚¯ã‚’ç¹‹ã’ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s105" src="img/a80d0310427cce38.png"></p>
<p>è¨­å®šã‚«ãƒ†ã‚´ãƒªã«ã‚ã‚‹ã€Œå•ã„åˆã‚ã›å±æ€§ã®è¨­å®šã€ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s106" src="img/ea34fc8d9bc4bffd.png"></p>
<p>å±æ€§ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚ã€Œå±æ€§ã‚’ä½¿ç”¨ã™ã‚‹ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>å®›å…ˆã‚­ãƒ¼</p>
</td><td colspan="1" rowspan="1"><p>message</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ã‚¿ã‚¤ãƒ—</p>
</td><td colspan="1" rowspan="1"><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>å±æ€§</p>
</td><td colspan="1" rowspan="1"><p>message</p>
</td></tr>
</table>
<p class="image-container"><img alt="s107" src="img/17fd381f0e39fd68.png"></p>
<p>ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç¹‹ã’ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s108" src="img/799fa7db13c65954.png"></p>
<p>æ“ä½œã‚«ãƒ†ã‚´ãƒªã«ã‚ã‚‹ã€Œãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†ç”Ÿã€ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s109" src="img/819a80fb6b1faf2d.png"></p>
<p>å±æ€§ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚ã€Œãƒ†ã‚­ã‚¹ãƒˆèª­ã¿ä¸Šã’æ©Ÿèƒ½(ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯)ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿ä¸Šã’æ©Ÿèƒ½(ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯)</p>
</td><td colspan="1" rowspan="1"><p>å‹•çš„ã«å…¥åŠ›ã™ã‚‹</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ã‚¿ã‚¤ãƒ—</p>
</td><td colspan="1" rowspan="1"><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>å±æ€§</p>
</td><td colspan="1" rowspan="1"><p>message</p>
</td></tr>
</table>
<p class="image-container"><img alt="s110" src="img/b41e3be5d26529da.png"></p>
<p>ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç¹‹ã’ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s111" src="img/a7511b4ee2d43b19.png"></p>
<p>ãƒ–ãƒ©ãƒ³ãƒã‚«ãƒ†ã‚´ãƒªã«ã‚ã‚‹ã€Œãƒ«ãƒ¼ãƒ—ã€ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã™ã€‚<br>ãƒ«ãƒ¼ãƒ—å›æ•°ã¯ãŠå¥½ããªæ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img alt="s112" src="img/55ca9d8973d704ca.png"></p>
<p>ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç¹‹ã’ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s113" src="img/7f891a46aee7db15.png"></p>
<p>ãƒ«ãƒ¼ãƒ—ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†ç”Ÿã‚’ç¹‹ã’ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s114" src="img/53a6bb73a8cf09ee.png"></p>
<p>çµ‚äº† / è»¢é€ã‚«ãƒ†ã‚´ãƒªã«ã‚ã‚‹ã€Œåˆ‡æ–­/ãƒãƒ³ã‚°ã‚¢ãƒƒãƒ—ã€ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s115" src="img/14d4cefaee1ab9d7.png"></p>
<p>ã¾ã ç¹‹ã„ã§ã„ãªã„éƒ¨åˆ†ã‚’å…¨ã¦ã€Œåˆ‡æ–­/ãƒãƒ³ã‚°ã‚¢ãƒƒãƒ—ã€ã«ç¹‹ãã¾ã™ã€‚</p>
<p class="image-container"><img alt="s116" src="img/2c3ebabd2d911bf7.png"></p>
<p>å³ä¸Šã®ï¼»ä¿å­˜ï¼½ã¨ã€Œå…¬é–‹ã€ãƒœã‚¿ãƒ³ã‚’é †ç•ªã«ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s117" src="img/aba156ef4722d749.png"></p>
<h2 is-upgraded>1-2. IDã‚’ãƒ¡ãƒ¢ã—ã¦ãŠã</h2>
<p>å•ã„åˆã‚ã›ãƒ•ãƒ­ãƒ¼ã®åå‰ã®ä¸‹ã«ã€Œè¿½åŠ ã®ãƒ•ãƒ­ãƒ¼æƒ…å ±ã®è¡¨ç¤ºã€ã¨ã„ã†é …ç›®ãŒã‚ã‚‹ã®ã§ã€ãã‚Œã‚’å±•é–‹ã—ã¾ã™ã€‚å±•é–‹ã™ã‚‹ã¨ARNã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§instanceã®IDã¨constact-flowã®IDã‚’ãã‚Œãã‚Œãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™ã€‚</p>
<p class="image-container"><img alt="s118" src="img/6d5e0f82e50d9ab6.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Lambdaé–¢æ•°ã‚’ä½œæˆã—ã‚ˆã†ï¼" duration="0">
        <h2 is-upgraded>2-1. Lambdaé–¢æ•°ã‚’ä½œæˆã™ã‚‹</h2>
<p>Lambdaã‹ã‚‰æ–°è¦ã§é–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚ï¼»é–¢æ•°ã®ä½œæˆï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s130" src="img/8c99246ba555faee.png"></p>
<p>é–¢æ•°ã¯ä»¥ä¸‹ã®é€šã‚Šå…¥åŠ›ã—ã¦ã€ï¼»é–¢æ•°ã®ä½œæˆï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>â‘ é–¢æ•°å</p>
</td><td colspan="1" rowspan="1"><p>M5StickC-AmazonConnect</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>â‘¡ãƒ©ãƒ³ã‚¿ã‚¤ãƒ </p>
</td><td colspan="1" rowspan="1"><p>Node.js 10.x</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>â‘¢å®Ÿè¡Œãƒ­ãƒ¼ãƒ«</p>
</td><td colspan="1" rowspan="1"><p>æ–°ã—ã„ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆ</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>â‘£ãƒ­ãƒ¼ãƒ«å</p>
</td><td colspan="1" rowspan="1"><p>M5StickC-AmazonConnect-Role</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>â‘¤ãƒãƒªã‚·ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</p>
</td><td colspan="1" rowspan="1"><p>åŸºæœ¬çš„ãªLambda@Edgeã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™</p>
</td></tr>
</table>
<p class="image-container"><img alt="s131" src="img/eec5eb5d03868510.png"></p>
<h2 is-upgraded>2-2. Amazon Connectã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¿½åŠ ã™ã‚‹</h2>
<p>M5StickC-AmazonConnect-Roleãƒ­ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s132" src="img/ddaa9098facef95f.png"></p>
<p>ï¼»ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ã®è¿½åŠ ï¼½ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s133" src="img/edea18ad5f35ebf3.png"></p>
<p>ã‚µãƒ¼ãƒ“ã‚¹ã‚’å±•é–‹ã—ã¦ã€æ¤œç´¢çª“ã«ã€ŒConnectã€ã¨å…¥ã‚Œã¦æ¤œç´¢ã—ã¾ã™ã€‚å‡ºã¦ããŸï¼»Connectï¼½ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s134" src="img/8b1ccf8fd28152af.png"></p>
<p>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ãƒ™ãƒ«ã«ã‚ã‚‹ã€Œæ›¸ãè¾¼ã¿ã€éƒ¨åˆ†ã‚’å±•é–‹ã—ã¦ã€ãã®ä¸­ã«ã‚ã‚‹<code>StartOutboundVoiceContact</code>ã®ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¾ã™ã€‚</p>
<p class="image-container"><img alt="s135" src="img/477078943385911.png"></p>
<p>ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ã€å³ä¸‹ã®ï¼»ãƒãƒªã‚·ãƒ¼ã®ç¢ºèªï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s136" src="img/9ee73d2d9d7fa867.png"></p>
<p>ãƒãƒªã‚·ãƒ¼åã‚’å…¥åŠ›ã—ã¾ã™ã€‚<code>M5Stick-AmazonConnect-Policy</code>ã¨ã—ã¾ã—ãŸã€‚å³ä¸‹ã®ï¼»ãƒãƒªã‚·ãƒ¼ã®ä½œæˆï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s137" src="img/1bc6d7e6953570a5.png"></p>
<p>Lambdaç”»é¢ã«æˆ»ã‚Šã€ç”»é¢æ›´æ–°ã™ã‚‹ã¨Amazon Connectã®æ¨©é™ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚</p>
<p class="image-container"><img alt="s138" src="img/e33e416eb0e8ebea.png"></p>
<h2 is-upgraded>2-3. ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ãè¾¼ã‚€</h2>
<p>index.jsã‚’é–‹ãã€ä¸‹è¨˜ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚<br>LINE Thingsã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã‚“ã§ãã‚‹ã®ã§ã€bodyã‹ã‚‰å¯¾è±¡å€¤ã‚’å–å¾—ã—ã¾ã™ã€‚base64ã§æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãƒ‡ã‚³ãƒ¼ãƒ‰å‡¦ç†ãŒå¿…è¦ã§ã™ã€‚</p>
<pre><code>const Util = require(&#39;./util.js&#39;);

exports.handler = async (event) =&gt; {
    const body = JSON.parse(event.body);
    const thingsData = body.events[0].things.result;

    const response = {
        statusCode: 200,
        body: JSON.stringify(&#39;Hello from M5StickC!&#39;),
    };

    if (thingsData.bleNotificationPayload) {
        // LINE Thingsã‹ã‚‰é£›ã‚“ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const blePayload = thingsData.bleNotificationPayload;
        var buffer1 = new Buffer(blePayload, &#39;base64&#39;);
        var stickData = buffer1.toString(&#39;ascii&#39;);  //Base64ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
        console.log(&#34;M5StickC-Payload=&#34; + stickData);
        
        const sendMessage = `ã‚¨ãƒ ãƒ•ã‚¡ã‚¤ãƒ–ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®å€¤ã¯ã€Œ${stickData}ã€ã§ã™ã€‚`;

        // Amazon Connecté€ä¿¡
        await Util.callMessageAction(sendMessage);

    }  
    return response;
};
</code></pre>
<p>æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s150" src="img/abf30af0880b11b9.png"></p>
<p>ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>&#39;use strict&#39;;
const AWS = require(&#39;aws-sdk&#39;);
var connect = new AWS.Connect();

// é›»è©±ã‚’ã‹ã‘ã‚‹å‡¦ç†
module.exports.callMessageAction = async function callMessageAction(message) {
    return new Promise(((resolve, reject) =&gt; {

        // Attributesã«ç™ºè©±ã™ã‚‹å†…å®¹ã‚’è¨­å®š
        var params = {
            Attributes: {&#34;message&#34;: message},
            InstanceId: process.env.INSTANCEID,
            ContactFlowId: process.env.CONTACTFLOWID,
            DestinationPhoneNumber: process.env.PHONENUMBER,
            SourcePhoneNumber: process.env.SOURCEPHONENUMBER
        };

        // é›»è©±ã‚’ã‹ã‘ã‚‹
        connect.startOutboundVoiceContact(params, function(err, data) {
            if (err) {
                console.log(err);
                reject();
            } else {
                resolve(data);
            }
        });
    }));
};
</code></pre>
<p>ä¿å­˜ã™ã‚‹éš›ã¯ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã€Œutil.jsã€ã«ã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img alt="s151" src="img/2678b20879a33de6.png"></p>
<h2 is-upgraded>2-4. ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹</h2>
<p>Amazon Connectã¨é€£æºã™ã‚‹ãŸã‚ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>INSTANCEID</p>
</td><td colspan="1" rowspan="1"><p>1-2ã§ãƒ¡ãƒ¢ã—ãŸinstanceã®ID</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>CONTACTFLOWID</p>
</td><td colspan="1" rowspan="1"><p>1-2ã§ãƒ¡ãƒ¢ã—ãŸcontact-flowã®ID</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>PHONENUMBER</p>
</td><td colspan="1" rowspan="1"><p>ã”è‡ªèº«ã®æºå¸¯é›»è©±ç•ªå· â€»+81ã‚’å…ˆé ­ã«ã¤ã‘ã¦æ•°å­—ã®ã¿ã«ã—ã¾ã™<br>ä¾‹)090-1234-5678 ğŸ‘‰+819012345678</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SOURCEPHONENUMBER</p>
</td><td colspan="1" rowspan="1"><p>Amazon Connectã§å–å¾—ã—ãŸé›»è©±ç•ªå· â€»+81ã‚’å…ˆé ­ã«ã¤ã‘ã¦æ•°å­—ã®ã¿ã«ã—ã¾ã™</p>
</td></tr>
</table>
<p class="image-container"><img alt="s152" src="img/498b6f52e6b824da.png"></p>
<h2 is-upgraded>2-5. API Gatewayã‚’è¨­å®šã™ã‚‹</h2>
<p>LINE Thingsã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®URLã‚’ç™ºè¡Œã—ã¾ã™ã€‚<br>ï¼»ãƒˆãƒªã‚¬ãƒ¼ã‚’è¿½åŠ ï¼½ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s153" src="img/7b9a82b5715baaec.png"></p>
<p>ãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®šã¯ä¸‹è¨˜ã‚’æŒ‡å®šã—ã¾ã™ã€‚æœ€å¾Œã«ï¼»è¿½åŠ ï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>ãƒˆãƒªã‚¬ãƒ¼</p>
</td><td colspan="1" rowspan="1"><p>API Gateway</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>API</p>
</td><td colspan="1" rowspan="1"><p>æ–°è¦APIã®ä½œæˆ</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</p>
</td><td colspan="1" rowspan="1"><p>ã‚ªãƒ¼ãƒ—ãƒ³</p>
</td></tr>
</table>
<p class="image-container"><img alt="s154" src="img/449b26fa8ec3ff98.png"></p>
<p>APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®URLã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã—ã‚‡ã†</p>
<p class="image-container"><img alt="s155" src="img/5ed2b9e5f7f61274.png"></p>
<p>å³ä¸Šã®ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s156" src="img/55dc44ac52705e9f.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="LINE Botã‚’ä½œã‚ã†ï¼" duration="0">
        <h2 is-upgraded>3-1. ãƒãƒ£ãƒãƒ«ã®ä½œæˆ</h2>
<p>ä¸‹è¨˜ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚<br><a href="https://developers.line.biz/ja/" target="_blank">https://developers.line.biz/ja/</a></p>
<p>ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒã¾ã ç„¡ã„æ–¹ã¯ä½œæˆãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
<p>æ–°è¦ãƒãƒ£ãƒãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s160" src="img/deb92c7bb94383df.png"></p>
<p>Messaging APIã‚’ã‚¯ãƒªãƒƒã‚¯</p>
<p class="image-container"><img alt="s161" src="img/5f0e6a9eac54ab8a.png"></p>
<p>ï¼»åŒæ„ã™ã‚‹ï¼½ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
<p class="image-container"><img alt="s162" src="img/c13113bf456b1192.png"></p>
<p>2ã¤ã®ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã‹ã‚‰ï¼»ä½œæˆï¼½ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
<p class="image-container"><img alt="s163" src="img/6db23266224a8ab.png"></p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>â‘ ã‚¢ãƒ—ãƒªå</p>
</td><td colspan="1" rowspan="1"><p>M5StickCé€£æºãƒãƒ³ã‚ºã‚ªãƒ³</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>â‘¡ã‚¢ãƒ—ãƒªèª¬æ˜</p>
</td><td colspan="1" rowspan="1"><p>M5StickCé€£æºãƒãƒ³ã‚ºã‚ªãƒ³</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>â‘¢å¤§æ¥­ç¨®</p>
</td><td colspan="1" rowspan="1"><p>æ—…è¡Œãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ»ãƒ¬ã‚¸ãƒ£ãƒ¼</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>â‘£å°æ¥­ç¨®</p>
</td><td colspan="1" rowspan="1"><p>ãã®ä»–å¨¯æ¥½ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>â‘¤ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</p>
</td><td colspan="1" rowspan="1"><p>ã”è‡ªèº«ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</p>
</td></tr>
</table>
<p class="image-container"><img alt="s164" src="img/3e8499d5bfbfec48.png"></p>
<p>ï¼»å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã™ã‚‹ï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
<p class="image-container"><img alt="s165" src="img/dca793e2933d83aa.png"></p>
<p>ä½œæˆã—ãŸãƒãƒ£ãƒãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™</p>
<p class="image-container"><img alt="s166" src="img/ee0a566c7d4de2cb.png"></p>
<h2 is-upgraded>3-2. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹</h2>
<p>ã“ã®ãƒãƒ£ãƒãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¾ã™ã€‚</p>
<p>ï¼»å†ç™ºè¡Œï¼½ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s167" src="img/40f44ace807afd0c.png"></p>
<p>[å†ç™ºè¡Œ]ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
<p class="image-container"><img alt="s168" src="img/f6c876f9e790532a.png"></p>
<p>ç™ºè¡Œã•ã‚ŒãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚</p>
<p class="image-container"><img alt="s169" src="img/665b435776a43333.png"></p>
<h2 is-upgraded>3-3. Webhookã‚’è¨­å®š</h2>
<p>Webhookã®ã‚¢ã‚¯ã‚»ã‚¹å…ˆURLã‚’æŒ‡å®šã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s170" src="img/fe8b59d73786682d.png"></p>
<p>2-5ã§ä½œæˆã—ãŸAPI Gatewayã®URLã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚ã€Œhttps://ã€ã¯æ—¢ã«ã‚ã‚‹ã®ã§ã€çœç•¥ã—ã¦è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚ï¼»æ›´æ–°ï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s171" src="img/e2f1941e7951cdef.png"></p>
<p>Webhooké€ä¿¡ã‚’åˆ©ç”¨ã™ã‚‹ã«å¤‰ãˆã¾ã™</p>
<p class="image-container"><img alt="s172" src="img/a598f86223c2d391.png"></p>
<p>åˆ©ç”¨ã™ã‚‹ã‚’é¸æŠã—ã¦ï¼»æ›´æ–°ï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚<br>ç¨€ã«åˆ©ç”¨ã™ã‚‹ã«å¤‰ã‚ã‚‰ãªã„ã“ã¨ãŒã‚ã‚‹ã®ã§ã€ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img alt="s173" src="img/c7b001657007d4c1.png"></p>
<h2 is-upgraded>3-4. LIFFã‚’è¨­å®šã™ã‚‹</h2>
<p>LIFFã‚¢ãƒ—ãƒªã‚’è¨­å®šã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s174" src="img/e8417e9b0e63d6cf.png"></p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>â‘ åå‰</p>
</td><td colspan="1" rowspan="1"><p>M5Stick-AmazonConnect</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>â‘¡ã‚µã‚¤ã‚º</p>
</td><td colspan="1" rowspan="1"><p>Tall</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>â‘¢ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL</p>
</td><td colspan="1" rowspan="1"><p>https://www.google.com/</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>â‘£ã‚ªãƒ—ã‚·ãƒ§ãƒ³</p>
</td><td colspan="1" rowspan="1"><p>å¿…ãšONã«ã™ã‚‹</p>
</td></tr>
</table>
<p class="image-container"><img alt="s175" src="img/8b723a28a99e1e05.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="LINE Thingsã®è¨­å®šã‚’ã—ã‚ˆã†ï¼" duration="0">
        <h2 is-upgraded>4-1. ã‚·ãƒŠãƒªã‚ªã‚’ä½œæˆã™ã‚‹</h2>
<p>ã®ã³ã™ã‘ã•ã‚“ãŒä½œã£ãŸãƒ„ãƒ¼ãƒ«ã‚’ã‚ã‚ŠãŒãŸãä½¿ã„ã¾ã™ã€‚<br>ä¸‹è¨˜ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
<p><a href="https://n0bisuke.github.io/linethingsgen/" target="_blank">https://n0bisuke.github.io/linethingsgen/</a></p>
<p>å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®Settingã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€3-2ã§ç”Ÿæˆã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚<br>ï¼»ä¿å­˜ï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s177" src="img/70ed93aa75c8de34.png"></p>
<p>å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®Create Productã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰3-4ã§ä½œæˆã—ãŸLIFFã‚¢ãƒ—ãƒªã‚’æŒ‡å®šã—ã¾ã™ã€‚<br>ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®åå‰ã‚’å…¥åŠ›ã—ã¦ï¼»ä¿å­˜ï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s178" src="img/1a6484985a793827.png"></p>
<p>å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®Create Scenarioã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰é¸æŠã€‚<br>ãã®ã¾ã¾ã®çŠ¶æ…‹ã§ï¼»ã‚·ãƒŠãƒªã‚ªã‚»ãƒƒãƒˆã®ç™»éŒ²/æ›´æ–°ï¼½ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img alt="s179" src="img/2ecdfa628a99ebb1.png"></p>
<p>ç™ºè¡Œã•ã‚ŒãŸserviceUuidã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™ã€‚</p>
<p class="image-container"><img alt="s180" src="img/ebe3b11249e5f9e9.png"></p>
<h2 is-upgraded>4-2. LINEã‚¢ãƒ—ãƒªã®LINE Thingsæœ‰åŠ¹åŒ–</h2>
<p>æ—¢ã«æœ‰åŠ¹åŒ–ã—ã¦ã„ã‚‹æ–¹ã¯ã“ã®æ‰‹é †ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚<br>ä»¥ä¸‹ã®URLã‚’èª­ã¿è¾¼ã‚“ã§ã€LINE Thingsã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img alt="s181" src="img/d9de05a792d38df4.png"></p>
<p>è¨­å®šãƒšãƒ¼ã‚¸ã«LINE Thingsã®é …ç›®ãŒå¢—ãˆã¾ã™</p>
<p class="image-container"><img alt="s182" src="img/77cffa0e01353b54.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="M5Stickã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¾¼ã‚€" duration="0">
        <h2 is-upgraded>5-1. ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¾¼ã‚€</h2>
<p>Arduino IDEã‚’é–‹ã„ã¦ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚<br>11è¡Œç›®ã®ã‚µãƒ¼ãƒ“ã‚¹UUIDã¯4-1ã§ç”Ÿæˆã—ãŸå€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
<p>ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã‹ã‚‰ã‚‚ã‚³ãƒ”ãƒšã§ãã¾ã™</p>
<p><a href="https://github.com/gaomar/tokyo-gaomar-03/raw/master/files/M5Stick-AmazonConnect/M5Stick-AmazonConnect.ino" target="_blank">https://github.com/gaomar/tokyo-gaomar-03/raw/master/files/M5Stick-AmazonConnect/M5Stick-AmazonConnect.ino</a></p>
<pre><code>#include &lt;BLEDevice.h&gt;
#include &lt;BLEServer.h&gt;
#include &lt;BLEUtils.h&gt;
#include &lt;BLE2902.h&gt;
#include &lt;M5StickC.h&gt;

// Device Name: Maximum 30 bytes
#define DEVICE_NAME &#34;M5Stick&#34;

// ã‚ãªãŸã®ã‚µãƒ¼ãƒ“ã‚¹UUIDã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
#define USER_SERVICE_UUID &#34;ï¼œã‚ãªãŸã®ã‚µãƒ¼ãƒ“ã‚¹UUIDï¼&#34;
// Notify UUID: ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç‰ˆã¯å€¤ãŒå›ºå®šã•ã‚Œã‚‹
#define NOTIFY_CHARACTERISTIC_UUID &#34;62FBD229-6EDD-4D1A-B554-5C4E1BB29169&#34;
// PSDI Service UUID: ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç‰ˆã¯å€¤ãŒå›ºå®šã•ã‚Œã‚‹
#define PSDI_SERVICE_UUID &#34;E625601E-9E55-4597-A598-76018A0D293D&#34;
// PSDI CHARACTERISTIC UUID: ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç‰ˆã¯å€¤ãŒå›ºå®šã•ã‚Œã‚‹
#define PSDI_CHARACTERISTIC_UUID &#34;26E2B12B-85F0-4F3F-9FDD-91D114270E6E&#34;

BLEServer* thingsServer;
BLESecurity* thingsSecurity;
BLEService* userService;
BLEService* psdiService;
BLECharacteristic* psdiCharacteristic;
BLECharacteristic* notifyCharacteristic;

bool deviceConnected = false;
bool oldDeviceConnected = false;

class serverCallbacks: public BLEServerCallbacks {
  void onConnect(BLEServer* pServer) {
   deviceConnected = true;
  };

  void onDisconnect(BLEServer* pServer) {
    deviceConnected = false;
  }
};

void setup() {
  Serial.begin(115200);

  BLEDevice::init(&#34;&#34;);
  BLEDevice::setEncryptionLevel(ESP_BLE_SEC_ENCRYPT_NO_MITM);

  // Security Settings
  BLESecurity *thingsSecurity = new BLESecurity();
  thingsSecurity-&gt;setAuthenticationMode(ESP_LE_AUTH_BOND);
  thingsSecurity-&gt;setCapability(ESP_IO_CAP_NONE);
  thingsSecurity-&gt;setInitEncryptionKey(ESP_BLE_ENC_KEY_MASK | ESP_BLE_ID_KEY_MASK);

  setupServices();
  startAdvertising();

  // M5Stick LCD Setup
  M5.begin(true, false, false);

  // æ¨ªå‘ã
  M5.Lcd.setRotation(3);

  // ãƒœã‚¿ãƒ³åˆæœŸåŒ–
  pinMode(M5_BUTTON_HOME, INPUT);  
  pinMode(M5_BUTTON_RST, INPUT);

  M5.Lcd.fillScreen(TFT_BLACK);
  M5.Lcd.setTextColor(YELLOW);
  M5.Lcd.setCursor(0, 0);   
  M5.Lcd.print(&#34;Ready to Connect&#34;);
  Serial.println(&#34;Ready to Connect&#34;);
}

int btnValue = 0;

void loop() {

  if(digitalRead(M5_BUTTON_RST) == LOW) {
    // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
    btnValue++;
    M5.Lcd.fillScreen(TFT_BLACK);
    M5.Lcd.setTextSize(2);
    M5.Lcd.setCursor(0, 0);
    M5.Lcd.print(&#34;Count&#34;);
    M5.Lcd.setTextColor(GREEN);
    M5.Lcd.setCursor(30, 40);
    M5.Lcd.printf(&#34;%d&#34;, btnValue);

    // ãƒœã‚¿ãƒ³ãŒé›¢ã•ã‚Œã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
    while(digitalRead(M5_BUTTON_RST) == LOW);
  }

  if(digitalRead(M5_BUTTON_HOME) == LOW) {
    // LINE Botã«ç´ã¥ãWebhookã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡
    const char *newValue=((String)btnValue).c_str();
    notifyCharacteristic-&gt;setValue(newValue);
    notifyCharacteristic-&gt;notify();

    M5.Lcd.fillScreen(TFT_BLACK);
    M5.Lcd.setTextSize(2);
    M5.Lcd.setCursor(0, 0);
    M5.Lcd.print(&#34;Send!!&#34;);

    // ãƒœã‚¿ãƒ³ãŒé›¢ã•ã‚Œã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
    while(digitalRead(M5_BUTTON_HOME) == LOW);

    // ã‚«ã‚¦ãƒ³ãƒˆåˆæœŸåŒ–
    btnValue = 0;
    delay(3000);
    M5.Lcd.fillScreen(TFT_BLACK);
    M5.Lcd.setCursor(0, 0);
    M5.Lcd.print(&#34;Count&#34;);
    M5.Lcd.setTextColor(GREEN);
    M5.Lcd.setCursor(30, 40);
    M5.Lcd.printf(&#34;%d&#34;, btnValue);    
  }

  // Disconnection
  if (!deviceConnected &amp;&amp; oldDeviceConnected) {
    delay(500); // Wait for BLE Stack to be ready
    thingsServer-&gt;startAdvertising(); // Restart advertising
    oldDeviceConnected = deviceConnected;
    M5.Lcd.fillScreen(TFT_BLACK);
    M5.Lcd.setTextColor(YELLOW);
    M5.Lcd.setCursor(0, 0);     
    M5.Lcd.print(&#34;Ready to Connect&#34;);
  }
  // Connection
  if (deviceConnected &amp;&amp; !oldDeviceConnected) {
    oldDeviceConnected = deviceConnected;
    M5.Lcd.fillScreen(TFT_BLACK);
    M5.Lcd.setTextColor(GREEN);
    M5.Lcd.setCursor(0, 0);       
    M5.Lcd.print(&#34;Connected&#34;);
  }
}

// ã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–
void setupServices(void) {
  // Create BLE Server
  thingsServer = BLEDevice::createServer();
  thingsServer-&gt;setCallbacks(new serverCallbacks());

  // Setup User Service
  userService = thingsServer-&gt;createService(USER_SERVICE_UUID);

  // Notifyã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  notifyCharacteristic = userService-&gt;createCharacteristic(NOTIFY_CHARACTERISTIC_UUID, BLECharacteristic::PROPERTY_NOTIFY);
  notifyCharacteristic-&gt;setAccessPermissions(ESP_GATT_PERM_READ_ENCRYPTED | ESP_GATT_PERM_WRITE_ENCRYPTED);
  BLE2902* ble9202 = new BLE2902();
  ble9202-&gt;setNotifications(true);
  ble9202-&gt;setAccessPermissions(ESP_GATT_PERM_READ_ENCRYPTED | ESP_GATT_PERM_WRITE_ENCRYPTED);
  notifyCharacteristic-&gt;addDescriptor(ble9202);

  // Setup PSDI Service
  psdiService = thingsServer-&gt;createService(PSDI_SERVICE_UUID);
  psdiCharacteristic = psdiService-&gt;createCharacteristic(PSDI_CHARACTERISTIC_UUID, BLECharacteristic::PROPERTY_READ);
  psdiCharacteristic-&gt;setAccessPermissions(ESP_GATT_PERM_READ_ENCRYPTED | ESP_GATT_PERM_WRITE_ENCRYPTED);

  // Set PSDI (Product Specific Device ID) value
  uint64_t macAddress = ESP.getEfuseMac();
  psdiCharacteristic-&gt;setValue((uint8_t*) &amp;macAddress, sizeof(macAddress));

  // Start BLE Services
  userService-&gt;start();
  psdiService-&gt;start();
}

void startAdvertising(void) {
  // Start Advertising
  BLEAdvertisementData scanResponseData = BLEAdvertisementData();
  scanResponseData.setFlags(0x06); // GENERAL_DISC_MODE 0x02 | BR_EDR_NOT_SUPPORTED 0x04
  scanResponseData.setName(DEVICE_NAME);

  thingsServer-&gt;getAdvertising()-&gt;addServiceUUID(userService-&gt;getUUID());
  thingsServer-&gt;getAdvertising()-&gt;setScanResponseData(scanResponseData);
  thingsServer-&gt;getAdvertising()-&gt;start();
}
</code></pre>
<p class="image-container"><img alt="s185" src="img/29689240c8387684.png"></p>
<p>LINEã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã€20190722ãƒãƒ³ã‚ºã‚ªãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¾ã™</p>
<p class="image-container"><img alt="s183" src="img/c200bb400f3ff7f8.png"></p>
<p>ï¼»ä»Šã™ãåˆ©ç”¨ï¼½ã‚’ã‚¿ãƒƒãƒ—ã—ã¾ã™</p>
<p class="image-container"><img alt="s184" src="img/df14a38cb29eb534.png"></p>
<p>æ¨ªã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¢ãƒƒãƒ—ã•ã›ã¦ã€ä¸­å¤®ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨Amazon Connectã‹ã‚‰å€¤ã‚’æ•™ãˆã¦ãã‚Œã¾ã™ã€‚</p>
<p>7/22ã®M5StickC + LINE Things + Amazon Connecté€£æºãƒãƒ³ã‚ºã‚ªãƒ³ã¯ã“ã‚Œã‚’ä½œã‚Šã¾ã™ï¼æŠ¼ã—ãŸãƒœã‚¿ãƒ³ã®å€¤ã‚’æ•™ãˆã¦ãã‚Œã¾ã™ã€‚<a href="https://t.co/HIdM5EDfGw" target="_blank">https://t.co/HIdM5EDfGw</a><a href="https://twitter.com/hashtag/M5StickC?src=hash&ref_src=twsrc%5Etfw" target="_blank">#M5StickC</a><a href="https://twitter.com/hashtag/AmazonConnect?src=hash&ref_src=twsrc%5Etfw" target="_blank">#AmazonConnect</a><a href="https://t.co/lKGUZPb7m2" target="_blank">pic.twitter.com/lKGUZPb7m2</a></p>
<p>â€” ãŒãŠã¾ã‚‹@ã‚¹ãƒãƒ¼ãƒˆã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚¢ãƒ—ãƒªé–‹ç™ºå…¥é–€ç™ºå£²ä¸­ï¼ (@gaomar) <a href="https://twitter.com/gaomar/status/1146329025687670784?ref_src=twsrc%5Etfw" target="_blank">July 3, 2019</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="M5Stackã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¾¼ã‚€" duration="0">
        <h2 is-upgraded>6-1. ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¾¼ã‚€</h2>
<p>M5Stackã‚’ãŠæŒã¡ã®æ–¹ã¯ã“ã¡ã‚‰ã§ã™ã€‚</p>
<p>Arduino IDEã‚’é–‹ã„ã¦ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚<br>11è¡Œç›®ã®ã‚µãƒ¼ãƒ“ã‚¹UUIDã¯4-1ã§ç”Ÿæˆã—ãŸå€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
<p>ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã‹ã‚‰ã‚‚ã‚³ãƒ”ãƒšã§ãã¾ã™</p>
<p><a href="https://github.com/gaomar/tokyo-gaomar-03/raw/master/files/M5Stack-AmazonConnect/M5Stick-AmazonConnect.ino" target="_blank">https://github.com/gaomar/tokyo-gaomar-03/raw/master/files/M5Stack-AmazonConnect/M5Stick-AmazonConnect.ino</a></p>
<pre><code>#include &lt;BLEDevice.h&gt;
#include &lt;BLEServer.h&gt;
#include &lt;BLEUtils.h&gt;
#include &lt;BLE2902.h&gt;
#include &lt;M5Stack.h&gt;

// Device Name: Maximum 30 bytes
#define DEVICE_NAME &#34;M5Stick&#34;

// ã‚ãªãŸã®ã‚µãƒ¼ãƒ“ã‚¹UUIDã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
#define USER_SERVICE_UUID &#34;ï¼œã‚ãªãŸã®ã‚µãƒ¼ãƒ“ã‚¹UUIDï¼&#34;
// Notify UUID: ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç‰ˆã¯å€¤ãŒå›ºå®šã•ã‚Œã‚‹
#define NOTIFY_CHARACTERISTIC_UUID &#34;62FBD229-6EDD-4D1A-B554-5C4E1BB29169&#34;
// PSDI Service UUID: ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç‰ˆã¯å€¤ãŒå›ºå®šã•ã‚Œã‚‹
#define PSDI_SERVICE_UUID &#34;E625601E-9E55-4597-A598-76018A0D293D&#34;
// PSDI CHARACTERISTIC UUID: ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç‰ˆã¯å€¤ãŒå›ºå®šã•ã‚Œã‚‹
#define PSDI_CHARACTERISTIC_UUID &#34;26E2B12B-85F0-4F3F-9FDD-91D114270E6E&#34;

BLEServer* thingsServer;
BLESecurity* thingsSecurity;
BLEService* userService;
BLEService* psdiService;
BLECharacteristic* psdiCharacteristic;
BLECharacteristic* notifyCharacteristic;

bool deviceConnected = false;
bool oldDeviceConnected = false;

class serverCallbacks: public BLEServerCallbacks {
  void onConnect(BLEServer* pServer) {
   deviceConnected = true;
  };

  void onDisconnect(BLEServer* pServer) {
    deviceConnected = false;
  }
};

void setup() {
  Serial.begin(115200);

  BLEDevice::init(&#34;&#34;);
  BLEDevice::setEncryptionLevel(ESP_BLE_SEC_ENCRYPT_NO_MITM);

  // Security Settings
  BLESecurity *thingsSecurity = new BLESecurity();
  thingsSecurity-&gt;setAuthenticationMode(ESP_LE_AUTH_BOND);
  thingsSecurity-&gt;setCapability(ESP_IO_CAP_NONE);
  thingsSecurity-&gt;setInitEncryptionKey(ESP_BLE_ENC_KEY_MASK | ESP_BLE_ID_KEY_MASK);

  setupServices();
  startAdvertising();

  // M5Stick LCD Setup
  M5.begin(true, false, false);
  M5.Lcd.clear(BLACK);
  M5.Lcd.setTextColor(YELLOW);
  M5.Lcd.setTextSize(2);
  M5.Lcd.setCursor(0, 0);
  M5.Lcd.println(&#34;Ready to Connect&#34;);
  Serial.println(&#34;Ready to Connect&#34;);

}

int btnValue = 0;

void loop() {

  M5.update();

  if (M5.BtnA.wasPressed()) {
    // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
    btnValue++;
    M5.Lcd.fillScreen(TFT_BLACK);
    M5.Lcd.setTextSize(2);
    M5.Lcd.setCursor(0, 0);
    M5.Lcd.print(&#34;Count&#34;);
    M5.Lcd.setTextColor(GREEN);
    M5.Lcd.setCursor(30, 40);
    M5.Lcd.printf(&#34;%d&#34;, btnValue);

  }

  if (M5.BtnB.wasPressed()) {
    // LINE Botã«ç´ã¥ãWebhookã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡
    const char *newValue=((String)btnValue).c_str();
    notifyCharacteristic-&gt;setValue(newValue);
    notifyCharacteristic-&gt;notify();

    M5.Lcd.fillScreen(TFT_BLACK);
    M5.Lcd.setTextSize(2);
    M5.Lcd.setCursor(0, 0);
    M5.Lcd.print(&#34;Send!!&#34;);

    // ã‚«ã‚¦ãƒ³ãƒˆåˆæœŸåŒ–
    btnValue = 0;
    delay(3000);
    M5.Lcd.fillScreen(TFT_BLACK);
    M5.Lcd.setCursor(0, 0);
    M5.Lcd.print(&#34;Count&#34;);
    M5.Lcd.setTextColor(GREEN);
    M5.Lcd.setCursor(30, 40);
    M5.Lcd.printf(&#34;%d&#34;, btnValue);    
  }

  // Disconnection
  if (!deviceConnected &amp;&amp; oldDeviceConnected) {
    delay(500); // Wait for BLE Stack to be ready
    thingsServer-&gt;startAdvertising(); // Restart advertising
    oldDeviceConnected = deviceConnected;
    M5.Lcd.fillScreen(TFT_BLACK);
    M5.Lcd.setTextColor(YELLOW);
    M5.Lcd.setCursor(0, 0);     
    M5.Lcd.print(&#34;Ready to Connect&#34;);
  }
  // Connection
  if (deviceConnected &amp;&amp; !oldDeviceConnected) {
    oldDeviceConnected = deviceConnected;
    M5.Lcd.fillScreen(TFT_BLACK);
    M5.Lcd.setTextColor(GREEN);
    M5.Lcd.setCursor(0, 0);       
    M5.Lcd.print(&#34;Connected&#34;);
  }
}

// ã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–
void setupServices(void) {
  // Create BLE Server
  thingsServer = BLEDevice::createServer();
  thingsServer-&gt;setCallbacks(new serverCallbacks());

  // Setup User Service
  userService = thingsServer-&gt;createService(USER_SERVICE_UUID);

  // Notifyã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  notifyCharacteristic = userService-&gt;createCharacteristic(NOTIFY_CHARACTERISTIC_UUID, BLECharacteristic::PROPERTY_NOTIFY);
  notifyCharacteristic-&gt;setAccessPermissions(ESP_GATT_PERM_READ_ENCRYPTED | ESP_GATT_PERM_WRITE_ENCRYPTED);
  BLE2902* ble9202 = new BLE2902();
  ble9202-&gt;setNotifications(true);
  ble9202-&gt;setAccessPermissions(ESP_GATT_PERM_READ_ENCRYPTED | ESP_GATT_PERM_WRITE_ENCRYPTED);
  notifyCharacteristic-&gt;addDescriptor(ble9202);

  // Setup PSDI Service
  psdiService = thingsServer-&gt;createService(PSDI_SERVICE_UUID);
  psdiCharacteristic = psdiService-&gt;createCharacteristic(PSDI_CHARACTERISTIC_UUID, BLECharacteristic::PROPERTY_READ);
  psdiCharacteristic-&gt;setAccessPermissions(ESP_GATT_PERM_READ_ENCRYPTED | ESP_GATT_PERM_WRITE_ENCRYPTED);

  // Set PSDI (Product Specific Device ID) value
  uint64_t macAddress = ESP.getEfuseMac();
  psdiCharacteristic-&gt;setValue((uint8_t*) &amp;macAddress, sizeof(macAddress));

  // Start BLE Services
  userService-&gt;start();
  psdiService-&gt;start();
}

void startAdvertising(void) {
  // Start Advertising
  BLEAdvertisementData scanResponseData = BLEAdvertisementData();
  scanResponseData.setFlags(0x06); // GENERAL_DISC_MODE 0x02 | BR_EDR_NOT_SUPPORTED 0x04
  scanResponseData.setName(DEVICE_NAME);

  thingsServer-&gt;getAdvertising()-&gt;addServiceUUID(userService-&gt;getUUID());
  thingsServer-&gt;getAdvertising()-&gt;setScanResponseData(scanResponseData);
  thingsServer-&gt;getAdvertising()-&gt;start();
}

</code></pre>
<p>æ›¸ãè¾¼ã‚€ãƒœãƒ¼ãƒ‰ã®è¨­å®šã¯ä»¥ä¸‹ã®é€šã‚Š</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>ãƒœãƒ¼ãƒ‰</p>
</td><td colspan="1" rowspan="1"><p>M5Stack-Core-ESP32</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>Upload Speed</p>
</td><td colspan="1" rowspan="1"><p>921600</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ã‚·ãƒªã‚¢ãƒ«ãƒãƒ¼ãƒˆ</p>
</td><td colspan="1" rowspan="1"><p>/dev/cu.SLAB_USBtoUART</p>
</td></tr>
</table>
<p class="image-container"><img alt="s186" src="img/bbc5a851d2f65490.png"></p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
